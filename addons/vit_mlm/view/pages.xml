<openerp>
<data>

<template id="website.member_children">
    <t t-foreach="member.child_ids" t-as="child">
	  {
		 "name":"<t t-esc="child.name"/>",
		 "parent":"<t t-esc="member.name" />",
		 "children":[
	        <t t-foreach="child.child_ids" t-as="child2">
			  {
	    		 "name":"<t t-esc="child2.name"/>",
	    		 "parent":"<t t-esc="child.name" />",
	    		 "children":[
					<t t-call="website.member_children">
						<t t-set="member" t-value="child2"/>
					</t>	
	    		 ]
			  },
	        </t>				

		 ]
	  },
    </t>	
</template>

<template id="website.member_tree" name="Member Tree" page="True">
	<h1>Member Tree</h1>
	<!-- load the d3.js library -->	
	<script src="/vit_mlm/static/src/d3.min.js"></script>
	<script>
		var treeData = [
			{"name": "<t t-esc="member.name"/>",
				"parent":"null",
				"children":[
					<t t-call="website.member_children">
						<t t-set="member" t-value="member"/>
					</t>			
				]
			}
		];
	var margin = {top: 40, right: 120, bottom: 20, left: 120},
		width = 960 - margin.right - margin.left,
		height = 800 - margin.top - margin.bottom;
		
	var i = 0,
		duration = 650,
		root;

	var tree = d3.layout.tree()
		.size([height, width]);

	var diagonal = d3.svg.diagonal()
		.projection(function(d) { return [d.x, d.y]; });

	var svg = d3.select("#tree").append("svg")
		.attr("width", width + margin.right + margin.left)
		.attr("height", height + margin.top + margin.bottom)
		.append("g")
		.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

	root = treeData[0];
	update(root);


	function update(source) {

		// Compute the new tree layout.
		// node adalah object tree node lengkap: x, y, x0,y0, depth, id, parent, name
		var nodes = tree.nodes(root).reverse(),
					links = tree.links(nodes);

		// Normalize for fixed-depth.
		nodes.forEach(function(d) { d.y = d.depth * 80; });

		/*
		// Update the nodes
		We then declare the variable / function node so that when we call it 
		later it will know to select the appropriate object (a node) 
		with the appropriate .id.*/

		var node = svg.selectAll("g.node")
			.data(nodes, function(d) { return d.id || (d.id = ++i); });

		/*
		// Enter any new nodes at the parent's previous position.
		The next block of code assigns the variable / function nodeEnter 
		to the action of appending a node to a particular position.
		*/
		var nodeEnter = node.enter().append("g")
			.attr("class", "node")
		      .attr("transform", function(d) { return "translate(" + source.x0 + "," + source.y0 + ")"; })
			.on("click", click);

		/*
		Then we get to the piece of code that appends the circle that 
		comprises the node (using nodeEnter).
		*/

		nodeEnter.append("circle")
			.attr("r", 1)
			.style("fill", 
				function(d) { return d._children ? "lightsteelblue" : "#fff"; });

		/*
		And we add in the text for each node
		*/
		nodeEnter.append("text")
			.attr("x", function(d) { 
				return d.children || d._children ? -10 : 10; })
			.attr("dy", ".35em")
			.attr("text-anchor", 
				function(d) { return d.children || d._children ? "end" : "start"; })
			.text(function(d) { return d.name; })
			.style("fill-opacity", 1e-6);

		// Transition nodes to their new position.
		var nodeUpdate = node.transition()
			.duration(duration)
			.attr("transform", 
				function(d) { return "translate(" + d.x + "," + d.y	 + ")"; });

		nodeUpdate.select("circle")
			.attr("r", 8.5)
			.style("fill", 
				function(d) { return d._children ? "lightsteelblue" : "#fff"; });

		nodeUpdate.select("text")
			.style("fill-opacity", 1);

		// Transition exiting nodes to the parent's new position.
		var nodeExit = node.exit().transition()
			.duration(duration)
			.attr("transform", 
				function(d) { return "translate(" + source.x + "," + source.y + ")"; })
			.remove();

		nodeExit.select("circle")
			.attr("r", 1e-6);

		nodeExit.select("text")
			.style("fill-opacity", 1e-6);

		// Update the linksâ€¦
		var link = svg.selectAll("path.link")
			.data(links, function(d) { return d.target.id; });

		// Enter any new links at the parent's previous position.
		link.enter().insert("path", "g")
			.attr("class", "link")
			.attr("d", function(d) {
				var o = {x: source.x0, y: source.y0};
				return diagonal({source: o, target: o});
			});

		// Transition links to their new position.
		link.transition()
			.duration(duration)
			.attr("d", diagonal);

		// Transition exiting nodes to the parent's new position.
		link.exit().transition()
			.duration(duration)
			.attr("d", function(d) {
				var o = {x: source.x, y: source.y};
				return diagonal({source: o, target: o});
			})
			.remove();

		// Stash the old positions for transition.
		nodes.forEach(function(d) {
			d.x0 = d.x;
			d.y0 = d.y;
		});
	}


		// Toggle children on click.
		function click(d) {
			if (d.children) {
				d._children = d.children;
				d.children = null;
			} else {
				d.children = d._children;
				d._children = null;
			}
			update(d);


		}
	</script>
</template>

<template id="website.member_list" name="Member List" page="True">
    <t t-call="website.layout">
        <t t-set="title">Member List</t>
        <div class="oe_structure">

            <div class="container">

            	<a class="btn btn-primary" href="/mlm/member/create" role="button">Add Downline</a>

                <t t-foreach="members" t-as="member">
                    <h2>
                    	<a t-attf-href="/mlm/member/view/{{ slug(member) }}">
                    		 <t t-esc="member.name"/>
                    	</a>
                    </h2>
                    
                    <p>
            			Member ID: <t t-esc="member.code"/><br/>
            			Upline ID: <span t-field="member.parent_id"/><br/>
            			Sponsor ID: <span t-field="member.sponsor_id"/><br/>
            			Address: <t t-esc="member.street"/>
            			<t t-esc="member.street2"/>
            			<t t-esc="member.city"/>
            			<span t-field="member.country_id"/>
            		</p>

                    <p>
            			Phone: <t t-esc="member.street"/><br/>
            			Email: <t t-esc="member.email"/><br/>
            			BBM: <t t-esc="member.bbm"/><br/>
            		</p>
                </t>
            </div>
        </div>
    </t>			
</template>

<template id="website.add_member_thanks" name="Member Add Thank You" 
	page="True">
    <t t-call="website.layout">
        <t t-set="title">Member Added</t>
        <div class="oe_structure">
            <div class="container">
            	<p>Thanks !</p>
            </div>
        </div>
    </t>			
</template>

<template id="website.member_form" name="Member Form" page="True">

	<div t-attf-class="form-group #{error and 'name' in error and 'has-error' or ''}">
		<label class="col-md-3 col-sm-4 control-label" for="name">Name</label>
		<div class="col-md-7 col-sm-8">
			<input type="text" class="form-control" name="name" 
				 required="True" 
				 t-attf-readonly="#{True if readonly==1 else False}"
				 t-attf-value="#{member and member.name or ''}"/>
		</div>
	</div>

	<div t-attf-class="form-group">
		<label class="col-md-3 col-sm-4 control-label" for="parent_id">Upline ID</label>
		<div class="col-md-7 col-sm-8">

			<t t-if="readonly==0">
				<select class="form-control" required="True" name="parent_id" 
					 t-attf-readonly="#{True if readonly==1 else False}">
				    <option value="">Upline...</option>
				    <t t-foreach="members or []" t-as="parent">
				        <option t-att-value="parent.id" t-attf-selected="#{member and member.parent_id.id == parent.id}">
				        	<t t-esc="parent.name"/>
				        </option>
				    </t>
				</select>
			</t>
			<t t-if="readonly==1">
				<input class="form-control" readonly="true" t-attf-value="#{member and member.parent_id and member.parent_id.name or ''}" />
			</t>
		</div>
	</div>

	<div t-attf-class="form-group">
		<label class="col-md-3 col-sm-4 control-label" for="sponsor_id">Sponsor ID</label>
		<div class="col-md-7 col-sm-8">
			<t t-if="readonly==0">
				<select class="form-control" required="True" name="sponsor_id" 
					 t-attf-readonly="#{True if readonly==1 else False}">
				    <option value="">Sponsor...</option>
				    <t t-foreach="members or []" t-as="sponsor">
				        <option t-att-value="sponsor.id" t-attf-selected="#{member and member.sponsor_id.id == sponsor.id}">
				        	<t t-esc="sponsor.name"/>
				        </option>
				    </t>
				</select>		
			</t>
			<t t-if="readonly==1">
				<input class="form-control"  readonly="true" t-attf-value="#{member and member.sponsor_id and member.sponsor_id.name or ''}" />
			</t>					 
		</div>
	</div>

	<div t-attf-class="form-group">
		<label class="col-md-3 col-sm-4 control-label" for="paket_id">Paket</label>
		<div class="col-md-7 col-sm-8">
			<t t-if="readonly==0">
				<select class="form-control" required="True" name="paket_id" 
					 t-attf-readonly="#{True if readonly==1 else False}">
				    <option value="">Paket...</option>
				    <t t-foreach="pakets or []" t-as="paket">
				        <option t-att-value="paket.id" t-attf-selected="#{member and member.paket_id.id == paket.id}"><t t-esc="paket.name"/></option>
				    </t>
				</select>
			</t>
			<t t-if="readonly==1">
				<input class="form-control"  readonly="true" t-attf-value="#{member and member.paket_id and member.paket_id.name or ''}" />
			</t>				
		</div>
	</div>


	<div t-attf-class="form-group">
		<label class="col-md-3 col-sm-4 control-label" for="street">Street</label>
		<div class="col-md-7 col-sm-8">
			<input type="text" class="form-control" name="street" id="street" 
				 t-attf-readonly="#{True if readonly==1 else False}"
				 t-attf-value="#{member and member.street or ''}"/>
		</div>
	</div>


	<div t-attf-class="form-group">
		<label class="col-md-3 col-sm-4 control-label" for="street2">Street 2</label>
		<div class="col-md-7 col-sm-8">
			<input type="text" class="form-control" name="street2" id="street2" 
				 t-attf-readonly="#{True if readonly==1 else False}"
				 t-attf-value="#{member and member.street2 or ''}"/>
		</div>
	</div>


	<div t-attf-class="form-group">
		<label class="col-md-3 col-sm-4 control-label" for="zip">ZIP</label>
		<div class="col-md-7 col-sm-8">
			<input type="text" class="form-control" name="zip" id="zip" 
				 t-attf-readonly="#{True if readonly==1 else False}"
				 t-attf-value="#{member and member.zip or ''}"/>
		</div>
	</div>


	<div t-attf-class="form-group">
		<label class="col-md-3 col-sm-4 control-label" for="city">City</label>
		<div class="col-md-7 col-sm-8">
			<input type="text" class="form-control" name="city" id="city" 
				 t-attf-readonly="#{True if readonly==1 else False}"
				 t-attf-value="#{member and member.city or ''}"/>
		</div>
	</div>



	<div t-attf-class="form-group">
		<label class="col-md-3 col-sm-4 control-label" for="country_id">Country</label>
		<div class="col-md-7 col-sm-8">
			<t t-if="readonly==0">
				<select class="form-control" required="True" name="country_id" 
					 t-attf-readonly="#{True if readonly==1 else False}">
				    <option value="">Country...</option>
				    <t t-foreach="countrys or []" t-as="country">
				        <option t-att-value="country.id" t-attf-selected="#{member and member.country_id.id == country.id}"><t t-esc="country.name"/></option>
				    </t>
				</select>
			</t>
			<t t-if="readonly==1">
				<input class="form-control"  readonly="true" t-attf-value="#{member and member.country_id and member.country_id.name or ''}" />
			</t>			
		</div>
	</div>	

	<div t-attf-class="form-group">
		<label class="col-md-3 col-sm-4 control-label" for="state_id">State</label>
		<div class="col-md-7 col-sm-8">
			<t t-if="readonly==0">
				<select class="form-control" required="True" name="state_id" 
					 t-attf-readonly="#{True if readonly==1 else False}">
				    <option value="">State...</option>
				    <t t-foreach="states or []" t-as="state">
				        <option t-att-value="state.id" t-attf-selected="#{member and member.state_id.id == state.id}"><t t-esc="state.name"/></option>
				    </t>
				</select>
			</t>
			<t t-if="readonly==1">
				<input class="form-control"  readonly="true" t-attf-value="#{member and member.state_id and member.state_id.name or ''}" />
			</t>				
		</div>
	</div>

	<div t-attf-class="form-group">
		<label class="col-md-3 col-sm-4 control-label" for="email">Email</label>
		<div class="col-md-7 col-sm-8">
			<input type="text" class="form-control" name="email" id="email" 
				 t-attf-readonly="#{True if readonly==1 else False}"
				 t-attf-value="#{member and member.email or ''}"/>
		</div>
	</div>


	<div t-attf-class="form-group">
		<label class="col-md-3 col-sm-4 control-label" for="bbm">BBM</label>
		<div class="col-md-7 col-sm-8">
			<input type="text" class="form-control" name="bbm" id="bbm"
				 t-attf-readonly="#{True if readonly==1 else False}"
			 	 t-attf-value="#{member and member.bbm or ''}"/>
		</div>
	</div>


	<div t-attf-class="form-group">
		<label class="col-md-3 col-sm-4 control-label" for="phone">Phone</label>
		<div class="col-md-7 col-sm-8">
			<input type="text" class="form-control" name="phone" id="phone" 
				 t-attf-readonly="#{True if readonly==1 else False}"
				 t-attf-value="#{member and member.phone or ''}"/>
		</div>
	</div>


	<div t-attf-class="form-group">
		<label class="col-md-3 col-sm-4 control-label" for="fax">Fax</label>
		<div class="col-md-7 col-sm-8">
			<input type="text" class="form-control" name="fax" id="fax" 
				 t-attf-readonly="#{True if readonly==1 else False}"
				 t-attf-value="#{member and member.fax or ''}"/>
		</div>
	</div>


	<div t-attf-class="form-group">
		<label class="col-md-3 col-sm-4 control-label" for="mobile">Mobile</label>
		<div class="col-md-7 col-sm-8">
			<input type="text" class="form-control" name="mobile" id="mobile" 
				 t-attf-readonly="#{True if readonly==1 else False}"
				 t-attf-value="#{member and member.mobile or ''}"/>
		</div>
	</div>
</template>

<template id="website.member_view" name="Member View" page="True">
	<t t-call="website.layout">


        <t t-set="title">Member View</t>
        <div class="oe_structure"/>
        
        <div class="oe_structure">
            <div class="container">

		        <div class="oe_structure"/>
		
		    	<a t-attf-href="/mlm/member/edit/{{ slug(member) }}" class="btn btn-primary" >Edit</a>

		        <div class="oe_structure"/>

                <h1 t-esc="member.name"/>
                <h2 t-esc="member.state"/>

		        <div class="form-horizontal mt32">
		        	<t t-call="website.member_form">
		        		<t t-set="readonly" t-value="1"/>
		        		<t t-set="member" t-value="member"/>
		        		<t t-set="parent" t-value="member.parent_id"/>
		        	</t>
		        </div>

		        <div class="oe_structure"/>
			    
			    <div role="tabpanel">

				  <!-- Nav tabs -->
				  <ul class="nav nav-tabs" role="tablist">
					    <li role="presentation" class="active"><a href="#downlines" aria-controls="downlines" role="tab" data-toggle="tab">Downlines</a></li>
					    <li role="presentation"><a href="#tree" aria-controls="tree" role="tab" data-toggle="tab">Tree</a></li>

					    <li role="presentation"><a href="#bonus" aria-controls="bonus" role="tab" data-toggle="tab">Bonus</a></li>
				  </ul>

				  <!-- Tab panes -->
				  <div class="tab-content">
					    <div role="tabpanel" class="tab-pane active" id="downlines">
					    	<table class="table table-striped">
					    		<tr>
					    			<th>Name</th>
					    			<th>Code</th>
					    			<th>Phone</th>
					    			<th>Mobile</th>
					    			<th>Email</th>
					    			<th>BBM</th>
				                </tr>			    		
			                <t t-foreach="member.child_ids or []" t-as="child">
					    		<tr>
					    			<td t-esc="child.name" />
					    			<td t-esc="child.code" />
					    			<td t-esc="child.phone" />
					    			<td t-esc="child.mobile" />
					    			<td t-esc="child.email" />
					    			<td t-esc="child.bbm" />
				                </tr>
				            </t>
				            </table>
					    </div>

					    <div role="tabpanel" class="tab-pane" id="tree">
					    	<t t-call="website.member_tree">
			                    <t t-set="member" t-value="member"/>
					    	</t>
					    </div>

					    <div role="tabpanel" class="tab-pane" id="bonus">
					    	<table class="table table-striped">
					    		<tr>
					    			<th>New Member</th>
					    			<th>At Level</th>
					    			<th>Amount</th>
					    			<th>Trans. Date</th>
					    			<th>Bonus Name</th>
					    			<th>Description</th>
					    			<th>Is Transferd</th>
				                </tr>			    		
			                <t t-foreach="member.member_bonus_ids or []" t-as="b">
					    		<tr>
					    			<td t-esc="b.new_member_id.name" />
					    			<td t-esc="b.level" />
					    			<td t-esc="b.amount" />
					    			<td t-esc="b.trans_date" />
					    			<td t-esc="b.bonus_id.name" />
					    			<td t-esc="b.description" />
					    			<td t-esc="b.is_transfered" />
				                </tr>
				            </t>
				            </table>
					    </div>
				  </div>
				</div>

            </div>
        </div>
        <div class="oe_structure"/>
    </t>			
</template>	

<template id="website.member_create" name="Create Member" page="True">
    <t t-call="website.layout">
        <t t-set="title">Create New Member</t>
        <div class="oe_structure">
            <div class="container">
               	<h1 t-esc="parent.name"/>

		        <form action="/mlm/member/add" method="post" class="form-horizontal mt32" enctype="multipart/form-data">

		        	<t t-call="website.member_form">
		        		<t t-set="readonly" t-value="0"/>
		        		<t t-set="member" t-value="member"/>
		        		<t t-set="members" t-value="members"/>
		        		<t t-set="parent" t-value="parent"/>
		        		<t t-set="pakets" t-value="pakets"/>
		        	</t>

		            <div class="form-group">
		                <div class="col-md-offset-3 col-sm-offset-4 col-sm-8 col-md-7">
		                    <button class="btn btn-primary btn-lg">Send</button>
		                </div>
		            </div>

		            <t t-foreach="kwargs" t-as="kwarg">
		                <input type="hidden" t-att-name="kwarg[0]" t-att-value="kwarg[1]"/>
		            </t>		            
		        </form>						
            </div>
        </div>
    </t>			
</template>

<template id="website.member_edit" name="Edit Member" page="True">
    <t t-call="website.layout">
        <t t-set="title">Edit Member</t>
        <div class="oe_structure">
            <div class="container">
               	<h1 t-esc="member.name"/>

		        <form action="/mlm/member/update" method="post" class="form-horizontal mt32" enctype="multipart/form-data">

		        	<t t-call="website.member_form">
		        		<t t-set="readonly" t-value="0"/>
		        		<t t-set="member" t-value="member"/>
		        		<t t-set="members" t-value="members"/>
		        		<t t-set="parent" t-value="parent"/>
		        		<t t-set="pakets" t-value="pakets"/>		        		
		        	</t>

		            <div class="form-group">
		                <div class="col-md-offset-3 col-sm-offset-4 col-sm-8 col-md-7">
		                    <button class="btn btn-primary btn-lg">Save</button>
		                </div>
		            </div>

	                <input type="hidden" name="id" t-att-value="member.id"/>
		            <t t-foreach="kwargs" t-as="kwarg">
		                <input type="hidden" t-att-name="kwarg[0]" t-att-value="kwarg[1]"/>
		            </t>		            
		        </form>						
            </div>
        </div>
    </t>			
</template>

<record id="member_menu" model="website.menu">
	<field name="name">Member</field>
	<field name="url">/mlm/member/list</field>
	<field name="parent_id" ref="website.main_menu"/>
	<field name="sequence" type="int">20</field>
</record>		

<template id="dummy_theme_asset" name="website assete for Dummy theme" 
	 inherit_id="website.theme">
	<xpath expr="." position="inside">
			<link rel="stylesheet" href="/vit_mlm/static/style/my.css"/>
	</xpath>
</template>	

</data>
</openerp>